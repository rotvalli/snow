<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Snow v0.1</title>
    <meta name="description" content="Snow simulation">
    <meta name="author" content="Otto Salminen">
    <style>
        body {
            font-family: sans-serif;
            background-color: black;
            background-image: url('landscape.jpg');
            background-size: 100% auto;
            background-repeat: no-repeat;
        }

        @media (orientation: portrait) {
            body {
                background-image: url('landscape2.jpg');
            }
        }

        #background {
            width: 100%;
            height: 100%;
            position: absolute;
            left: 0px;
            top: 0px;
            z-index: 0;
        }

        .stretch {
            width: 100%;
            height: 100%;
        }

        .flake {
            background: white;
            position: absolute;
            z-index: 999999;
        }
    </style>
</head>

<body onresize="init()">
    <script type="text/javascript">
        const body = document.body, html = document.documentElement;
        const minFps = 20;
        const flakeSize = 4.0;
        const speed = 1.0;
        const density = 2;

        let flakes = [];
        let oldTimeStamp;
        let height;

        const updateHeight = () => Math.max(body.scrollHeight, body.offsetHeight,
            html.clientHeight, html.scrollHeight, html.offsetHeight);

        const seedFlake = (top) => {
            const newFlake = document.createElement("div");
            newFlake.classList.add("flake");
            newFlake.style.top = top + "px";
            newFlake.style.left = (Math.random() * 97.0) + "%";
            newFlake.style.rotate = Math.round(Math.random() * 360.0) + "deg";
            newFlake.style.opacity = Math.random() + 0.2;
            newFlake.style.width = flakeSize + "px";
            newFlake.style.height = flakeSize + "px";
            body.appendChild(newFlake);
        }

        const remove = (sel) => document.querySelectorAll(sel).forEach(el => el.remove());

        const update = () => {
            flakes.map((e) => {
                const eTop = parseFloat(e.style.top || 0)
                if (eTop > height - flakeSize * 2.0) {
                    e.style.top = (-1 * flakeSize) + "px";
                }
                else {
                    e.style.top = (eTop + speed + Math.random()) + "px";
                    e.style.left = (parseFloat(e.style.left || 0) +
                        ((Math.random() - 0.5) / flakeSize)) + "%";
                }
            });
        }

        const loop = (timeStamp) => {
            const secondsPassed = (timeStamp - oldTimeStamp) / 1000;
            oldTimeStamp = timeStamp;
            const fps = Math.round(1 / secondsPassed);
            if (fps > minFps) {
                update();
            }
            window.requestAnimationFrame(loop);
        }

        const init = () => {
            height = updateHeight();
            remove(".flake");

            [...Array(density).keys()].map(
                _ => [...Array(height).keys()].map(h => seedFlake(h))
            );

            flakes = [...body.getElementsByClassName("flake")];
        }

        init();
        window.requestAnimationFrame(loop);
    </script>
</body>

</html>